<html>

	<head>
		<meta charset="utf-8"/>
		<title>Chat demo</title>
	</head>
	
	<body>
		<input type="text" id="username" placeholder = "username"/>
		<button id="conn" onclick="getEventSource(getUsername());">connect</button>
		<br>
		<input type="text" id="input" placeholder = "message" disabled/>
		<button onclick="send()" id="send" disabled>send</button>
		
		<script>
			
			var source = undefined;
			var userName = "";
			
			function getEventSource(username){
				
				if(username == "")
					return;
				
				source = new EventSource("/users/submit?name=" + username);
				userName = username;
				
				source.addEventListener("message", function(event){
					var response = JSON.parse(event.data);				
					receiveMessage("<strong>" + response.userName + "</strong>: " + response.message + "         " + response.instant);
				});
				
				source.onerror = function (){
					source.close();
					getEventSource(getUsername());
				};
				
				var input = document.getElementById("username");
				var conn = document.getElementById("conn");
				
				input.disabled = true;
				conn.disabled = true;
				
				var msg = document.getElementById("input");
				var send = document.getElementById("send");
				
				msg.disabled = false;
				send.disabled = false;
			}
			
			
			function send(){		
				
				var input = document.getElementById("input");
				var message  = input.value;
				var name = userName;
				
				var request = new XMLHttpRequest();
				request.open("POST", "/messages/send");
				request.setRequestHeader("content-type", "application/json;charset=UTF-8");
				request.send(JSON.stringify({
					"userName" : name,
					"message" : message,
					"instant" : null
				}));

			}
		
			function receiveMessage(message){
				var p = document.createElement("p");
				p.innerHTML = message;
				document.body.appendChild(p);
			}
		
			function getUsername(){
				var input = document.getElementById("username");
				return input.value;
			}
		
		</script>
	</body>

</html>